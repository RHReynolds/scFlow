---
title: "<b>scFlow</b> - Dataset Integration, Dimension Reduction, and Clustering Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: "flatly"
    toc: false
    fig_caption: true
    keep_md: false
    css: style.css
    includes:
      after_body: footer.html
params:
  metadata_path: false
  categorical_covariates: true
bibliography: references.bib
---

```{r setup, results='hide', include=FALSE}
library(DT)
library(utils)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
knitr::knit_hooks$set(wrap = function(before, options, envir) {
  if (before) {
    paste0("<", options$wrap, ' align="center">')
  } else {
    paste0("</", options$wrap, ">")
  }
})
```

```{r load_data, results='hide', include=FALSE}
metadata <- readRDS(params$metadata_path)
```

# Dataset Integration

Integration method: **Linked Inference of Genomic Experimental Relationships (LIGER)**[@Welch2019]

### LIGER Preprocessing

1. Data were normalized for different numbers of UMIs per cell.

2. Variable genes on each dataset were selected.

3. Data were scaled by root-mean-square across cells.

4. Cells/genes with no expression across any genes/cells were removed.

**Key parameters:**

- Number of variable genes per dataset (individual) selected for integration: **`r metadata$liger_params$liger_preprocess$num_genes`**

- Total number of variable genes used for integration (the union across all individuals): **`r length(metadata$liger_var.genes)`**

**Note**: The length of the union across datasets (individuals) varied. Please check the **Venn** and **UpSet** plots below and make sure there is no outlier dataset(s).

<div class = "row">
<div class = "col-md-12">
```{r, fig.align="center", fig.width=30, fig.height=20, eval=length(metadata$dataset_integration$var.genes_per_dataset) < 11}
knitr::opts_chunk$set(echo = FALSE)
my_nv <- metadata$dataset_integration$var.genes_plots$venn
nVennR::showSVG(my_nv)
nVennR::showSVG(my_nv)
```
`r if(length(metadata$dataset_integration$var.genes_per_dataset) < 11 ){sprintf("**Venn diagram of selected variable genes**: The large numbers indicate how many variable genes are common between datasets. The datasets are represented by the numbers in the parentheses.")}`
</div>
</div>
<div class = "row">
<div class = "col-md-12">
```{r, fig.align="center", fig.width=10, fig.height=6}
knitr::opts_chunk$set(echo = FALSE)
my_upset <- metadata$dataset_integration$var.genes_plots$upset
print(my_upset)
```
`r if(!is.null(metadata$dataset_integration$var.genes_per_dataset)){sprintf("**Upset chart of selected variable genes**: The first **%s** vertical bar charts show the sizes of isolated dataset participation to the total variable genes used for integration.", paste("<i>",length(metadata$dataset_integration$var.genes_per_dataset),"</i>", collapse = ", "))}`
</div>
</div>

### LIGER Factorization

1. An **integrative non-negative matrix factorization** was performed in order to identify shared and distinct metagenes (factors) across the datasets.

2. Corresponding factor/metagene loadings were performed for each cell. 

**Key parameters:**

- Number of **Factors** (inner dimension of factorization; **k**): **`r metadata$liger_params$liger_reduce_dims$k`**

- **Penalty** parameter which limits the dataset-specific component of the factorization (**lambda**): **`r metadata$liger_params$liger_reduce_dims$lambda`**

- **Resolution** parameter which controls the number of communities detected: **`r metadata$liger_params$liger_reduce_dims$resolution`**

# Dimension Reduction

- Data generated by **PCA** and **LIGER** were used as input for dimension reduction. 

- Dimension reduction was performed using **tSNE**, **UMAP**, and **UMAP3D** methods.

# Batch Effect Correction by LIGER 

- The performance of **LIGER** in batch effect correction has been compared against **PCA**. For each of the categorical covariates specified by the user two side-by-side comparisons have been represented:

1. Visualisation of the batch effect using **tSNE** plots.

2. Quantification of the batch effect based on **kBET**[@Büttner2019] test results. The rejection rate for each test represents the fraction of neighbourhoods with a label composition different from global composition of batch labels. A significantly different observed vs. expected rejection rate opposes the well-mixedness of the data.

```{r, results='asis', fig.hold='hold', out.width = "50%", fig.width=5, fig.height=4}
for (variable in categorical_covariates) {
cat("\\newpage")
cat("\n \n")
cat("\n \n")

cat(paste("### • Covariate:", variable, sep = " "), "\n\n")
cat("\n \n")
cat("\n")
tsne_pca <-
  metadata$dataset_integration$batch_correction_plots$pca_tsne_plots[[variable]]
print(tsne_pca)

plot_liger <- plot_reduced_dim(sce, feature_dim = variable,
  reduced_dim = "tSNE_Liger", size = 0.75, alpha = 0.3)
tsne_liger <-
  metadata$dataset_integration$batch_correction_plots$liger_tsne_plots[[variable]]
print(tsne_liger)
cat("\n")
cat("\n \n")

kbet_pca <-
  metadata$dataset_integration$batch_correction_plots$pca_kbet_plots[[variable]]
print(kbet_pca)

kbet_liger <-
  metadata$dataset_integration$batch_correction_plots$liger_kbet_plots[[variable]]
print(kbet_liger)

cat("\n")
}
```

# Clustering 

- Data generated by **PCA** and **LIGER** were used as input for clustering.

**Key parameters:**

- Clustering method: **`r metadata$cluster_params$cluster_method`**

- Number of nearest neighbors to use (**k**): **`r metadata$cluster_params$k`**

- **Resolution** parameter that controls the resolution of clustering.: **`r formatC(metadata$cluster_params$res)`**

```{r, results='asis', fig.hold='hold', out.width = "50%", fig.width=5, fig.height=4}
cat("\n \n")
cat("\n")

umap_pca <- metadata$dataset_integration$clustering_plots$umap_pca
print(umap_pca)

umap_liger <- metadata$dataset_integration$clustering_plots$umap_liger
print(umap_liger)
cat("\n")
cat("\n \n")
```
<br>scFlow v`r utils::packageVersion("scFlow")` -- `r Sys.time()`

# References