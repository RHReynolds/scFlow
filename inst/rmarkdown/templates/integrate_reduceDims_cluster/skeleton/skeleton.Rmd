---
title: "<b>scFlow</b> - Dataset Integration, Dimension Reduction, and Clustering Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: "flatly"
    toc: false
    fig_caption: true
    keep_md: false
    css: style.css
    includes:
      after_body: footer.html
params:
  metadata_path: false
  categorical_covariates: true
bibliography: references.bib
---

```{r setup, results='hide', include=FALSE}
library(DT)
library(utils)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
knitr::knit_hooks$set(wrap = function(before, options, envir) {
  if (before) {
    paste0("<", options$wrap, ' align="center">')
  } else {
    paste0("</", options$wrap, ">")
  }
})
```

```{r load_data, results='hide', include=FALSE}
metadata <- readRDS(params$metadata_path)
```

# Dataset Integration

Integration method: **Linked Inference of Genomic Experimental Relationships (LIGER)**[@Welch2019]

### LIGER Preprocessing

1. Data were normalized for different numbers of UMIs per cell.

2. Variable genes on each dataset were selected.

3. Data were scaled by root-mean-square across cells.

4. Cells/genes with no expression across any genes/cells were removed.

**Key parameters:**

- Number of variable genes per dataset (individual) selected for integration: **`r metadata$liger_params$liger_preprocess$num_genes`**

- Total number of variable genes used for integration (the union across all individuals): **`r length(metadata$liger_var.genes)`**

**Note**: The length of the union across datasets (individuals) varied. Please check the **Venn** and **UpSet** plots below and make sure there is no outlier dataset(s).

<div class = "row">
<div class = "col-md-12">
```{r, fig.align="center", fig.width=20, fig.height=6}
knitr::opts_chunk$set(echo = FALSE)
tmp <- tempfile()
venn_sets <- metadata$var.genes_per_dataset
my_nv <- nVennR::plotVenn(venn_sets)
my_nv <- nVennR::plotVenn(nVennObj = my_nv)
nVennR::showSVG(my_nv, outFile = tmp)
rsvg::rsvg_png(tmp, "./venn.png", width = 3000, height = 2000)
if (length(metadata$var.genes_per_dataset) < 11) {
  knitr::include_graphics("./venn.png")
  }
```
`r if(length(metadata$var.genes_per_dataset) < 11 ){sprintf("**Venn diagram of selected variable genes**: The large numbers indicate how many variable genes are common between datasets. The datasets are represented by the numbers in the parentheses.")}`
</div>
</div>
<div class = "row">
<div class = "col-md-12">
```{r, fig.align="center", fig.width=10, fig.height=6}
knitr::opts_chunk$set(echo = FALSE)
upset_sets <- metadata$var.genes_per_dataset
my_upset <- UpSetR::upset(fromList(upset_sets), nsets = length(upset_sets),
sets.x.label = "Variable genes per dataset",
text.scale = c(1.5, 1.5, 1.5, 1.5, 1.5, 1))
print(my_upset)
```
`r if(!is.null(metadata$var.genes_per_dataset)){sprintf("**Upset chart of selected variable genes**: The first **%s** vertical bar charts show the sizes of isolated dataset participation to the total variable genes used for integration.", paste("<i>",length(metadata$var.genes_per_dataset),"</i>", collapse = ", "))}`
</div>
</div>

### LIGER Factorization

1. An **integrative non-negative matrix factorization** was performed in order to identify shared and distinct metagenes (factors) across the datasets.

2. Corresponding factor/metagene loadings were performed for each cell. 

**Key parameters:**

- Number of **Factors** (inner dimension of factorization; **k**): **`r metadata$liger_params$liger_reduce_dims$k`**

- **Penalty** parameter which limits the dataset-specific component of the factorization (**lambda**): **`r metadata$liger_params$liger_reduce_dims$lambda`**

- **Resolution** parameter which controls the number of communities detected: **`r metadata$liger_params$liger_reduce_dims$resolution`**

# Dimension Reduction

- Data generated by **PCA** and **LIGER** were used as input for dimension reduction. 

- Dimension reduction was performed using **tSNE**, **UMAP**, and **UMAP3D** methods.

# Batch Effect Correction by LIGER 

- The performance of **LIGER** in batch effect correction has been compared against **PCA**. For each of the categorical covariates specified by the user two side-by-side comparisons have been represented:

1. Visualisation of the batch effect using **tSNE** plots.

2. Quantification of the batch effect based on **kBET**[@Büttner2019] test results. The rejection rate for each test represents the fraction of neighbourhoods with a label composition different from global composition of batch labels. A significantly different observed vs. expected rejection rate opposes the well-mixedness of the data.

```{r, results='asis', fig.hold='hold', out.width = "50%", fig.width=5, fig.height=4}
for (variable in categorical_covariates) {
cat("\\newpage")
cat("\n \n")
cat("\n \n")

cat(paste("### • Covariate:", variable, sep = " "), "\n\n")
cat("\n \n")
cat("\n")
plot_pca <- plot_reduced_dim(sce, feature_dim = variable,
  reduced_dim = "tSNE_PCA", size = 1, alpha = 0.3)
p <- plot_pca + ggtitle("tSNE using PCA data") +
  theme(plot.title = element_text(size = 15, face = "bold", hjust = 1.1))
print(p)

plot_liger <- plot_reduced_dim(sce, feature_dim = variable,
  reduced_dim = "tSNE_Liger", size = 0.75, alpha = 0.3)
p <- plot_liger + ggtitle("tSNE using LIGER data") +
  theme(plot.title = element_text(size = 15, face = "bold", hjust = 1.1))
print(p)
cat("\n")
cat("\n \n")

data <- SingleCellExperiment::reducedDim(sce, "PCA")
batch <- SummarizedExperiment::colData(sce)[[variable]]
subset_id <- sample.int(n = length(batch), size = floor(0.1 * length(batch)),
  replace = FALSE)
batch_estimate_pca <- kBET::kBET(data[subset_id, ], batch[subset_id],
  plot = FALSE)
plot.data <- data.frame(class = rep(c("observed", "expected"),
  each = length(batch_estimate_pca$stats$kBET.observed)),
  data =  c(batch_estimate_pca$stats$kBET.observed,
  batch_estimate_pca$stats$kBET.expected))
x_label <- sprintf("P-value = %s",
  formatC(batch_estimate_pca$summary$kBET.signif[1], format = "e", digits = 2))
kbet_plot_pca <- ggplot(plot.data, aes(class, data)) + geom_boxplot() +
  labs(x = x_label, y = "Rejection rate") + theme_bw() +
  scale_y_continuous(limits = c(0, 1)) +
  theme(axis.text = element_text(size = 13),
  axis.title = element_text(size = 13),
  axis.line = element_line(colour = "black"),
  panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ggtitle("kBET test results - PCA") +
  theme(plot.title = element_text(hjust = 0.5, size = 15, face = "bold"))
print(kbet_plot_pca)

data <- SingleCellExperiment::reducedDim(sce, "Liger")
batch <- SummarizedExperiment::colData(sce)[[variable]]
subset_id <- sample.int(n = length(batch), size = floor(0.1 * length(batch)),
  replace = FALSE)
batch_estimate_liger <- kBET::kBET(data[subset_id, ], batch[subset_id],
  plot = FALSE)
plot.data <- data.frame(class = rep(c("observed", "expected"),
  each = length(batch_estimate_liger$stats$kBET.observed)),
  data = c(batch_estimate_liger$stats$kBET.observed,
  batch_estimate_liger$stats$kBET.expected))
x_label <- sprintf("P-value = %s",
  formatC(batch_estimate_liger$summary$kBET.signif[1], format = "e",
  digits = 2))
kbet_plot_liger <- ggplot(plot.data, aes(class, data)) + geom_boxplot() +
  labs(x = x_label, y = "Rejection rate") + theme_bw() +
  scale_y_continuous(limits = c(0, 1)) +
  theme(axis.text = element_text(size = 13),
  axis.title = element_text(size = 13),
  axis.line = element_line(colour = "black"),
  panel.grid.minor = element_blank(), panel.background = element_blank()) +
  ggtitle("kBET test results - LIGER") +
  theme(plot.title = element_text(hjust = 0.5, size = 15, face = "bold"))
print(kbet_plot_liger)

cat("\n")
}
```

# Clustering 

- Data generated by **PCA** and **LIGER** were used as input for clustering.

**Key parameters:**

- Clustering method: **`r metadata$cluster_params$cluster_method`**

- Number of nearest neighbors to use (**k**): **`r metadata$cluster_params$k`**

- **Resolution** parameter that controls the resolution of clustering.: **`r formatC(metadata$cluster_params$res)`**

```{r, results='asis', fig.hold='hold', out.width = "50%", fig.width=5, fig.height=4}
cat("\n \n")
cat("\n")
plot_pca <- plot_reduced_dim(sce, feature_dim = "clusters",
  reduced_dim = "UMAP_PCA", size = 0.75, alpha = 0.3)
p <- plot_pca + ggtitle("UMAP using PCA data (colored by cluster)") +
  theme(plot.title = element_text(size = 15, face = "bold"))
print(p)

plot_liger <- plot_reduced_dim(sce, feature_dim = "clusters",
  reduced_dim = "UMAP_Liger", size = 0.75, alpha = 0.3)
p <- plot_liger + ggtitle("UMAP using LIGER data (colored by cluster)") +
  theme(plot.title = element_text(size = 15, face = "bold"))
print(p)
cat("\n")
cat("\n \n")
```
<br>scFlow v`r utils::packageVersion("scFlow")` -- `r Sys.time()`

# References